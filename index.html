<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Starforce Ladder Simulator (KMS) — Portfolio</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --bg: #0b0f14; --card: #121821; --muted: #93a1b3; --text: #e6edf3; --accent: #4cc2ff; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 20px 24px; border-bottom: 1px solid #1f2632; }
    h1 { margin: 0; font-weight: 800; letter-spacing: .2px; font-size: 20px; }
    main { max-width: 1100px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 1.1fr .9fr; gap: 16px; }
    .card { background: var(--card); border: 1px solid #1f2632; border-radius: 14px; box-shadow: 0 4px 24px rgba(0,0,0,.25); }
    .card h2 { margin: 0; padding: 14px 16px; border-bottom: 1px solid #1f2632; font-size: 16px; }
    .card .content { padding: 14px 16px; }
    label { display: block; font-size: 12px; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; letter-spacing: .6px; }
    input, select { width: 100%; padding: 10px 12px; background: #0f141c; border: 1px solid #2a3445; color: var(--text); border-radius: 10px; }
    .row { display: grid; grid-template-columns: repeat(4, 1fr) 36px; gap: 10px; align-items: end; }
    .row + .row { margin-top: 10px; }
    .btn { display: inline-flex; align-items: center; gap: 8px; background: #1a2330; border: 1px solid #2a3445; color: var(--text); padding: 10px 12px; border-radius: 10px; cursor: pointer; font-weight: 600; }
    .btn:hover { border-color: var(--accent); }
    .btn.primary { background: linear-gradient(180deg, #2a72ff, #0058d8); border: none; }
    .btn.small { padding: 6px 8px; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #1f2632; padding: 8px 8px; font-size: 13px; }
    th { color: var(--muted); text-align: left; font-weight: 600; }
    .muted { color: var(--muted); }
    .flex { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .grid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .mb8 { margin-bottom: 8px; }
    .mb12 { margin-bottom: 12px; }
    .mt8 { margin-top: 8px; }
    .mt16 { margin-top: 16px; }
    .mt24 { margin-top: 24px; }
    .right { text-align: right; }
    .pill { background:#0f141c; border:1px solid #2a3445; padding:6px 8px; border-radius:999px; font-size:12px; }
    footer { max-width:1100px; margin: 20px auto; padding: 0 20px 40px; color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
<header>
  <div style="display:flex; align-items:center; gap:12px;">
    <img src="changsoup.png" alt="MapleStory Live" style="height:180px; border-radius:8px;">
    <h1 style="margin:0;">Starforce Ladder Simulator — KMS Portfolio</h1>
  </div>
</header>
  <main>
    <section class="card">
      <h2>Inputs</h2>
      <div class="content">
        <div class="mb12">
          <div class="flex">
            <div style="min-width: 180px;">
              <label>Trials</label>
              <input id="trials" type="number" value="200" min="1" max="100000" />
            </div>
            <div style="min-width: 180px;">
              <label>Spare offset (SPARE = MAIN + offset)</label>
              <input id="spareOffset" type="number" value="1" min="1" max="5" />
            </div>
            <div style="min-width: 180px;">
              <label>New SPARE starts at ★</label>
              <input id="newSpareStart" type="number" value="12" min="0" max="30" />
            </div>
            <div style="min-width: 180px;">
              <label>Max star cap</label>
              <input id="maxStarCap" type="number" value="30" min="1" max="30" />
            </div>
          </div>
        </div>
        <div class="mb12 grid2">
          <div>
            <label>Flags</label>
            <div class="flex">
              <label class="pill"><input id="boomEvent" type="checkbox" /> Boom event</label>
              <label class="pill"><input id="thirtyOff" type="checkbox" /> 30% Off</label>
              <label class="pill"><input id="boomProtect" type="checkbox" /> Safeguard</label>
              <label class="pill"><input id="starCatch" type="checkbox" /> Star Catch</label>
            </div>
            <p class="muted mt8">Server fixed to <b>KMS</b>. No decreases.</p>
          </div>
          <div>
            <label>MVP (applies up to 15★)</label>
            <div class="flex">
              <label class="pill"><input name="mvp" type="radio" value="none" checked /> None</label>
              <label class="pill"><input name="mvp" type="radio" value="silver" /> Silver (-3%)</label>
              <label class="pill"><input name="mvp" type="radio" value="gold" /> Gold (-5%)</label>
              <label class="pill"><input name="mvp" type="radio" value="diamond" /> Diamond (-10%)</label>
            </div>
          </div>
        </div>

        <label>Items</label>
        <div id="rows"></div>
        <div class="mt8 flex">
          <button class="btn small" id="addRow">+ Add item</button>
          <span class="muted">1–20 items supported</span>
        </div>

        <div class="mt16">
          <button class="btn primary" id="runBtn">Run simulation</button>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>Results</h2>
      <div class="content">
        <div class="grid2">
          <div>
            <table>
              <tbody>
                <tr><th>Average total mesos</th><td class="right" id="avgTotal">—</td></tr>
                <tr><th>Median total mesos</th><td class="right" id="medTotal">—</td></tr>
                <tr><th>Range total mesos</th><td class="right" id="rngTotal">—</td></tr>
              </tbody>
            </table>
          </div>
          <div>
            <canvas id="finalStarChart" height="160"></canvas>
          </div>
        </div>
        <div class="mt16" id="perItem"></div>
      </div>
    </section>
  </main>
  <footer>
    Tip: host this file as <code>index.html</code> on GitHub Pages (Settings → Pages → deploy from main).
  </footer>

<script>
// --- RNG helper (JS Math.random is fine) ---
function rand() { return Math.random(); }

// --- KMS cost functions (exact port of your JS) ---
function makeMesoFn(divisor, currentStarExp = 2.7, extraMult = 1) {
  return (currentStar, itemLevel) => 100 * Math.round(extraMult * itemLevel ** 3 * ((currentStar + 1) ** currentStarExp) / divisor + 10);
}
function preSaviorMesoFn(current_star) {
  if (current_star >= 15) return makeMesoFn(20000);
  if (current_star >= 10) return makeMesoFn(40000);
  return makeMesoFn(2500, 1);
}
function kmsMesoFn(current_star) {
  switch (current_star) {
    case 11: return makeMesoFn(22000);
    case 12: return makeMesoFn(15000);
    case 13: return makeMesoFn(11000);
    case 14: return makeMesoFn(7500);
    case 17: return makeMesoFn(20000, 2.7, 4/3);
    case 18: return makeMesoFn(20000, 2.7, 20/7);
    case 19: return makeMesoFn(20000, 2.7, 40/9);
    case 21: return makeMesoFn(20000, 2.7, 8/5);
    default: return preSaviorMesoFn(current_star);
  }
}
function kmsCost(current_star, item_level) { return kmsMesoFn(current_star)(current_star, item_level); }

// --- KMS rates ---
const kmsRates = {
  0:[0.95,0.05,0,0],1:[0.9,0.1,0,0],2:[0.85,0.15,0,0],3:[0.85,0.15,0,0],4:[0.8,0.2,0,0],5:[0.75,0.25,0,0],6:[0.7,0.3,0,0],7:[0.65,0.35,0,0],8:[0.6,0.4,0,0],9:[0.55,0.45,0,0],10:[0.5,0.5,0,0],11:[0.45,0.55,0,0],12:[0.4,0.6,0,0],13:[0.35,0.65,0,0],14:[0.3,0.7,0,0],15:[0.3,0.679,0,0.021],16:[0.3,0.679,0,0.021],17:[0.15,0.782,0,0.068],18:[0.15,0.782,0,0.068],19:[0.15,0.765,0,0.085],20:[0.3,0.595,0,0.105],21:[0.15,0.7225,0,0.1275],22:[0.15,0.68,0,0.17],23:[0.1,0.72,0,0.18],24:[0.1,0.72,0,0.18],25:[0.1,0.72,0,0.18],26:[0.07,0.744,0,0.186],27:[0.05,0.76,0,0.19],28:[0.03,0.776,0,0.194],29:[0.01,0.792,0,0.198]
};

// --- Safeguard multiplier increase (JS port) ---
function getSafeguardMultiplierIncrease(current_star, sauna, server) {
  if (server === 'kms' && current_star >= 15 && current_star <= 17) return 2;
  if (server === 'old' && !sauna && current_star >= 12 && current_star <= 16) return 1;
  if (server !== 'kms' && current_star >= 15 && current_star <= 16) return 1;
  return 0;
}

function attemptCost(current_star, item_level, flags){
  let mult = 1;
  if (flags.mvp === 'silver' && current_star <= 15) mult -= 0.03;
  if (flags.mvp === 'gold'   && current_star <= 15) mult -= 0.05;
  if (flags.mvp === 'diamond'&& current_star <= 15) mult -= 0.10;
  if (flags.thirty_off) mult -= 0.30;
  if (flags.server === 'kms'){
    if (flags.boom_protect) mult += getSafeguardMultiplierIncrease(current_star, flags.sauna, flags.server);
  } else {
    if (flags.boom_protect) mult += getSafeguardMultiplierIncrease(current_star, flags.sauna, flags.server);
  }
  const base = kmsCost(current_star, item_level);
  return Math.round(base * mult);
}

function determineOutcome(current_star, rates, flags){
  let [pSucc, pMaint, pDecr, pBoom] = rates[current_star];
  // KMS: enforce no decrease
  pDecr = 0;
  // KMS boom event: shift 30% of boom prob to maintain up to 21★
  if (flags.boom_event && current_star <= 21){
    pMaint += pBoom * 0.3; pBoom *= 0.7;
  }
  // Safeguard (KMS): convert boom to maintain up to 17★
  if (flags.boom_protect && current_star <= 17){
    pMaint += pBoom; pBoom = 0;
  }
  // Star catch: +5% success, renormalize rest
  if (flags.star_catch){
    pSucc *= 1.05; const left = Math.max(0, 1 - pSucc); const rest = pMaint + pDecr + pBoom;
    if (rest > 0){ pMaint = pMaint * left / rest; pDecr = pDecr * left / rest; pBoom = pBoom * left / rest; }
    else { pMaint = pDecr = pBoom = 0; }
  }
  const r = rand();
  const s1 = pSucc, s2 = s1 + pMaint, s3 = s2 + pDecr;
  if (r <= s1) return 'Success';
  if (r <= s2) return 'Maintain';
  if (r <= s3) return 'Decrease';
  if (r <= s3 + pBoom) return 'Boom';
  return 'Success';
}

function attemptOnce(current_star, item_level, flags, rates){
  const cost = attemptCost(current_star, item_level, flags);
  const outcome = determineOutcome(current_star, rates, flags);
  return [cost, outcome];
}

function performLadderOnce(start_main_star, spares_count, item_level, flags, rates, new_spare_start_star, spare_offset, max_star_cap){
  let total = 0;
  let mainStar = start_main_star|0;
  let spareStar = start_main_star|0;
  let sparesLeft = spares_count|0;
  const mainBoomStars = [];
  const spareBoomStars = [];
  if (new_spare_start_star == null) new_spare_start_star = start_main_star;
  const canContinue = () => max_star_cap == null ? true : (mainStar < max_star_cap);

  while (canContinue()){
    let targetSpare = mainStar + spare_offset;
    if (max_star_cap != null) targetSpare = Math.min(targetSpare, max_star_cap);

    // Build SPARE up to MAIN + offset
    while (spareStar < targetSpare && canContinue()){
      const [cost, outcome] = attemptOnce(spareStar, item_level, flags, rates);
      total += cost;
      if (outcome === 'Success') spareStar += 1;
      else if (outcome === 'Maintain') {/*no-op*/}
      else if (outcome === 'Boom'){
        spareBoomStars.push(spareStar);
        if (sparesLeft <= 0) return { total_mesos: total, final_main_star: mainStar, spares_left: sparesLeft, main_boom_stars: mainBoomStars, spare_boom_stars: spareBoomStars };
        sparesLeft -= 1; spareStar = new_spare_start_star|0;
      }
    }

    if (!canContinue()) break;

    // Push MAIN up to SPARE (end if boom)
    while (mainStar < spareStar && canContinue()){
      const [cost, outcome] = attemptOnce(mainStar, item_level, flags, rates);
      total += cost;
      if (outcome === 'Success') mainStar += 1;
      else if (outcome === 'Maintain') {/*no-op*/}
      else if (outcome === 'Boom'){
        mainBoomStars.push(mainStar);
        mainStar = spareStar; // promote
        if (sparesLeft <= 0) return { total_mesos: total, final_main_star: mainStar, spares_left: sparesLeft, main_boom_stars: mainBoomStars, spare_boom_stars: spareBoomStars };
        sparesLeft -= 1; spareStar = new_spare_start_star|0; break;
      }
    }
  }

  return { total_mesos: total, final_main_star: mainStar, spares_left: sparesLeft, main_boom_stars: mainBoomStars, spare_boom_stars: spareBoomStars };
}

function repeatLadder(trials, start_main_star, spares_count, item_level, flags, rates, new_spare_start_star, spare_offset, max_star_cap){
  const results = []; const costs = []; const finalStars = []; const mainBooms = []; const spareBooms = [];
  for (let i=0;i<trials;i++){
    const r = performLadderOnce(start_main_star, spares_count, item_level, flags, rates, new_spare_start_star, spare_offset, max_star_cap);
    results.push(r); costs.push(r.total_mesos); finalStars.push(r.final_main_star);
    mainBooms.push(...r.main_boom_stars); spareBooms.push(...r.spare_boom_stars);
  }
  const avg = Math.round(costs.reduce((a,b)=>a+b,0)/trials);
  const med = costs.slice().sort((a,b)=>a-b)[Math.floor(trials/2)];
  const mx = Math.max(...costs), mn = Math.min(...costs);
  return { avg, med, mx, mn, results, finalStars, mainBooms, spareBooms };
}

function repeatPortfolio(trials, items, flags, rates, new_spare_start_star, spare_offset, max_star_cap){
  if (items.length < 1 || items.length > 20) throw new Error('items must be 1..20');
  const totals = []; const perItemCosts = {}; const perItemFinal = {}; const perItemMainBoom = {}; const perItemSpareBoom = {};
  items.forEach(it=>{ perItemCosts[it.name]=[]; perItemFinal[it.name]={}; perItemMainBoom[it.name]={}; perItemSpareBoom[it.name]={}; });

  const bump=(obj,k)=>obj[k]=(obj[k]||0)+1;

  for(let t=0;t<trials;t++){
    let total = 0;
    for(const it of items){
      const r = performLadderOnce(it.start, it.spares, it.level, flags, rates, (new_spare_start_star??it.start), spare_offset, max_star_cap);
      total += r.total_mesos;
      perItemCosts[it.name].push(r.total_mesos);
      bump(perItemFinal[it.name], r.final_main_star);
      r.main_boom_stars.forEach(s=>bump(perItemMainBoom[it.name], s));
      r.spare_boom_stars.forEach(s=>bump(perItemSpareBoom[it.name], s));
    }
    totals.push(total);
  }
  const avgTotal = Math.round(totals.reduce((a,b)=>a+b,0)/trials);
  const medTotal = totals.slice().sort((a,b)=>a-b)[Math.floor(trials/2)];
  const mx = Math.max(...totals), mn = Math.min(...totals);

  const perItemAvg={}, perItemMed={};
  for(const nm in perItemCosts){
    const arr = perItemCosts[nm];
    perItemAvg[nm]=Math.round(arr.reduce((a,b)=>a+b,0)/arr.length);
    perItemMed[nm]=arr.slice().sort((a,b)=>a-b)[Math.floor(arr.length/2)];
  }

  return { avgTotal, medTotal, mx, mn, totals, perItemFinal, perItemMainBoom, perItemSpareBoom, perItemAvg, perItemMed };
}

function histToPct(hist, denom){ const out={}; for(const k in hist){ out[k]= +(hist[k]*100/denom).toFixed(2); } return out; }
function fmt(n){ return n.toLocaleString('en-US'); }

// --- UI wiring ---
const rowsEl = document.getElementById('rows');
const addRowBtn = document.getElementById('addRow');
const runBtn = document.getElementById('runBtn');
const perItemEl = document.getElementById('perItem');
let chart;

function addRow(pref={name:'', start:22, spares:5, level:150}){
  const row = document.createElement('div'); row.className='row card'; row.style.padding='10px';
  row.innerHTML = `
    <div><label>Name</label><input value="${pref.name}" class="nm" placeholder="slime"/></div>
    <div><label>Main start ★</label><input type="number" value="${pref.start}" min="0" max="30" class="start"/></div>
    <div><label>Spares</label><input type="number" value="${pref.spares}" min="0" max="999" class="spares"/></div>
    <div><label>Item level</label><input type="number" value="${pref.level}" min="1" max="300" class="level"/></div>
    <div><button class="btn small del">✕</button></div>
  `;
  row.querySelector('.del').onclick = ()=> row.remove();
  rowsEl.appendChild(row);
}

addRow({name:'slime', start:22, spares:10, level:160});
addRow({name:'daybreak', start:22, spares:5, level:140});

addRowBtn.onclick = ()=> addRow();

function readFlags(){
  const mvp = [...document.querySelectorAll('input[name="mvp"]')].find(r=>r.checked)?.value || 'none';
  return {
    server: 'kms', item_type: 'normal', sauna:false,
    boom_event: document.getElementById('boomEvent').checked,
    thirty_off: document.getElementById('thirtyOff').checked,
    boom_protect: document.getElementById('boomProtect').checked,
    star_catch: document.getElementById('starCatch').checked,
    mvp
  };
}

function readItems(){
  const items=[];
  rowsEl.querySelectorAll('.row').forEach(row=>{
    const name = row.querySelector('.nm').value.trim()||'item';
    const start = parseInt(row.querySelector('.start').value,10)||0;
    const spares = parseInt(row.querySelector('.spares').value,10)||0;
    const level = parseInt(row.querySelector('.level').value,10)||1;
    items.push({name, start, spares, level});
  });
  return items;
}

runBtn.onclick = ()=>{
  const trials = parseInt(document.getElementById('trials').value,10)||100;
  const spareOffset = parseInt(document.getElementById('spareOffset').value,10)||1;
  const newSpareStart = parseInt(document.getElementById('newSpareStart').value,10)||12;
  const maxStarCap = parseInt(document.getElementById('maxStarCap').value,10)||30;
  const flags = readFlags();
  const items = readItems();

  const res = repeatPortfolio(trials, items, flags, kmsRates, newSpareStart, spareOffset, maxStarCap);

  document.getElementById('avgTotal').textContent = fmt(res.avgTotal);
  document.getElementById('medTotal').textContent = fmt(res.medTotal);
  document.getElementById('rngTotal').textContent = `${fmt(res.mn)} – ${fmt(res.mx)}`;

  // Per-item panels
  perItemEl.innerHTML = '';
  const labels = []; const data = [];
  items.forEach(it=>{
    const wrap = document.createElement('div'); wrap.className='card mt16';
    const finalPct = histToPct(res.perItemFinal[it.name], trials);
    const mainPct  = histToPct(res.perItemMainBoom[it.name], trials);
    const sparePct = histToPct(res.perItemSpareBoom[it.name], trials);

    // Build simple tables
    wrap.innerHTML = `
      <h2 style="padding:10px 12px;">${it.name}</h2>
      <div class="content">
        <table class="mb12">
          <tbody>
            <tr><th>Avg mesos</th><td class="right">${fmt(res.perItemAvg[it.name])}</td></tr>
            <tr><th>Median mesos</th><td class="right">${fmt(res.perItemMed[it.name])}</td></tr>
          </tbody>
        </table>
        <div class="grid2">
          <div>
            <label>Final star %</label>
            <div class="muted">${Object.entries(finalPct).map(([k,v])=>`★${k}: ${v}%`).join(' · ')||'—'}</div>
            <div class="mt8"><label>Main boom %</label>
            <div class="muted">${Object.entries(mainPct).map(([k,v])=>`★${k}: ${v}%`).join(' · ')||'—'}</div></div>
            <div class="mt8"><label>Spare boom %</label>
            <div class="muted">${Object.entries(sparePct).map(([k,v])=>`★${k}: ${v}%`).join(' · ')||'—'}</div></div>
          </div>
          <div>
            <small class="muted">(Top final-star bucket shown in chart)</small>
            <div class="mt8"></div>
          </div>
        </div>
      </div>`;

    perItemEl.appendChild(wrap);

    // collect for global chart: top final star for each item (by count)
    const final = res.perItemFinal[it.name];
    const top = Object.entries(final).sort((a,b)=>b[1]-a[1])[0];
    labels.push(it.name);
    data.push(top ? Number(top[0]) : 0);
  });

  // Simple bar chart: item vs most common final star
  const ctx = document.getElementById('finalStarChart');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{ label: 'Most common final star', data }] },
    options: { responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } } }
  });
};
</script>
</body>
</html>
